<!-- This file defines the navigation layout -->

@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Routing
@inject ObituaryBlazorWasm.Services.ITokenProvider Tokens
@inject NavigationManager Nav

<div class="memorial-body d-flex flex-column min-vh-100">

  <nav class="navbar navbar-expand-lg navbar-light bg-white memorial-navbar border-bottom">
    <div class="container">
      <a class="navbar-brand fw-semibold text-accent" href="/">Memorial</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">

          <!-- Home link -->
          <li class="nav-item">
            <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">Home</NavLink>
          </li>
          <li class="nav-item">
            <NavLink class="nav-link" href="/ask-ai" Match="NavLinkMatch.All">Ask AI</NavLink>
          </li>
          <!-- Create link (Only when logged in) -->
          @if (_hasToken)
          {
            <li class="nav-item">
              <NavLink class="nav-link" href="/obituaries/create">Create</NavLink>
            </li>
          }

          <!-- Logout link (Only when logged in) -->
          @if (_hasToken)
          {
            <li class="nav-item">
              <a class="nav-link" href="#" @onclick="Logout">Logout</a>
            </li>
          }
          else
          {
            <!-- Login link (Only when logged out) -->
            <li class="nav-item">
              <NavLink class="nav-link" href="/login">Login</NavLink>
            </li>
          }
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main content area -->
  <main class="flex-grow-1 memorial-main py-4">
    <div class="container">
      @Body
    </div>
  </main>

  <!-- Footer -->
  <footer class="memorial-footer border-top py-4">
    <div class="container text-center">
      <p class="text-muted small mb-0">
        &copy; @(DateTime.Now.Year) Memorial App · <a class="link-muted" href="/">Home</a>
      </p>
    </div>
  </footer>
</div>

@code {

  private bool _hasToken;

  /*
    Check if a token exists to determine login state.
    Also, listen for navigation changes to update login state accordingly.
  */
  protected override async Task OnInitializedAsync()
  {
    _hasToken = !string.IsNullOrWhiteSpace(await Tokens.GetTokenAsync());

    Nav.LocationChanged += async (_, __) =>
    {
      _hasToken = !string.IsNullOrWhiteSpace(await Tokens.GetTokenAsync());
      StateHasChanged();
    };
  }

  /*
    Logout by removing the token and navigating to home.
  */
  private async Task Logout()
  {
    await Tokens.RemoveTokenAsync();
    _hasToken = false;
    Nav.NavigateTo("/", forceLoad: false);
  }
}
