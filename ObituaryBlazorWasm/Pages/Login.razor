@page "/login"
@inject ObituaryBlazorWasm.Services.AuthApiClient Auth
@inject ObituaryBlazorWasm.Services.ITokenProvider Tokens
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Forms

<div class="auth-wrap">
  <div class="auth-card">
    <h2 class="auth-title">Welcome back</h2>
    <p class="auth-muted mb-4">Sign in to continue.</p>

    @if (!string.IsNullOrEmpty(_error))
    {
      <div class="alert alert-danger">@_error</div>
    }

    <EditForm Model="_m" OnValidSubmit="HandleLogin">
      <DataAnnotationsValidator />
      <div class="mb-3">
        <label class="form-label">Email</label>
        <InputText class="form-control" @bind-Value="_m.Email" />
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <InputText class="form-control" type="password" @bind-Value="_m.Password" />
      </div>
      <button class="btn auth-btn w-100" disabled="@_busy" type="submit">
        @(_busy ? "Signing in..." : "Sign In")
      </button>
    </EditForm>

    <p class="mt-3 mb-0 auth-muted">
      Donâ€™t have an account?
      <a class="auth-link" href="/signup">Create one</a>
    </p>
  </div>
</div>

@code {
  private class LoginModel { public string Email { get; set; } = ""; public string Password { get; set; } = ""; }
  private readonly LoginModel _m = new();
  private bool _busy;
  private string? _error;

  /*
    Handle user login
  */
  private async Task HandleLogin()
  {
    _busy = true; _error = null;
    var model = new ObituaryBlazorWasm.Models.Auth.LoginModel { Email = _m.Email, Password = _m.Password };
    var (ok, err) = await Auth.LoginAsync(model);
    _busy = false;

    if (!ok)
    {
      _error = string.IsNullOrWhiteSpace(err) ? "Login failed." : err;
      return;
    }

    Nav.NavigateTo("/", forceLoad: false);
  }
}
