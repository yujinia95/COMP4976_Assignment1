@* This view displays the details of a specific obituary. *@

@model ObituaryMvcApi.Models.Obituary
@{
    ViewData["Title"] = $"Memorial – {Model.FullName}";
    var age = Model.DateOfDeath.Year - Model.DateOfBirth.Year;
    if (Model.DateOfDeath < Model.DateOfBirth.AddYears(age)) { age--; }
}

<!-- Header -->
<section class="memorial-hero--sub" aria-labelledby="page-title">
  <div class="container">
    <div class="hero-inner">
      <i class="bi bi-person-heart" aria-hidden="true"></i>
      <h1 id="page-title" class="hero-title">In Loving Memory</h1>
      <p class="hero-subtitle">@Model.FullName</p>
    </div>
  </div>
</section>

<div class="container my-4">
  <div class="row g-4">

    <div class="col-lg-4 col-md-5">
      <article class="card memorial-summary h-100">

        @* Photo *@
        <div class="memorial-photo">
          @if (Model.Photo != null)
          {
              <img src="data:image/jpeg;base64,@Convert.ToBase64String(Model.Photo)"
                   alt="Portrait of @Model.FullName"
                   class="img-fluid w-100" />
          }
          else
          {
              <div class="photo-placeholder">
                  <i class="bi bi-person" aria-hidden="true"></i>
              </div>
          }
        </div>

        @* Name, dates, bio *@
        <div class="card-body text-center">
          <h2 class="memorial-name h3">@Model.FullName</h2>

          <p class="memorial-dates mb-2">
            <i class="bi bi-calendar-heart" aria-hidden="true"></i>
            <span>@Model.DateOfBirth.ToString("MMMM dd, yyyy")</span>
            <span class="sep">—</span>
            <span>@Model.DateOfDeath.ToString("MMMM dd, yyyy")</span>
          </p>

          <p class="text-muted mb-0"><small>Age: @age years</small></p>
        </div>

        @* Edit/Delete buttons for only authorized user*@
        <div class="card-footer">
          <div class="d-grid gap-2">
            @if (User.IsInRole("Admin") ||
                 (User.Identity?.IsAuthenticated ?? false) &&
                 User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.CreatedByUserId)
            {
              <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i> Edit Memorial
              </a>
              <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Delete Memorial
              </a>
            }

            @* Back to Gallery button *@
            <a asp-controller="ObituariesMvc" asp-action="Index" class="btn btn-secondary">
              <i class="bi bi-arrow-left"></i> Back to Gallery
            </a>

          </div>
        </div>
      </article>
    </div>

    <!-- Biography -->
    <div class="col-lg-8 col-md-7">
      <article class="card memorial-bio h-100">
      
        <div class="card-header bg-light">
          <h3 class="mb-0 h5"><i class="bi bi-book" aria-hidden="true"></i> Life Story</h3>
        </div>

        <div class="card-body">
          <div id="bioContainer" class="biography-content" data-maxchars="1600">
            @* Keep your newline → <br/> behavior but sanitize *@
            @Html.Raw(Html.Encode(Model.Biography ?? string.Empty).Replace("\n", "<br />"))
          </div>
          <div id="bioFade" class="bio-fade d-none" aria-hidden="true"></div>
          <button type="button" id="toggleBio" class="btn btn-link px-0 mt-2 d-none"
                  aria-controls="bioContainer" aria-expanded="false">
            Read more
          </button>
        </div>

        @* Created/Updated timestamps *@
        <div class="card-footer bg-light">
          <div class="row text-muted small">
            <div class="col-md-6">
              <span><i class="bi bi-clock" aria-hidden="true"></i>
                Created @Model.CreatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")
              </span>
            </div>
            @if (Model.UpdatedAt != Model.CreatedAt)
            {
              <div class="col-md-6">
                <span><i class="bi bi-pencil-square" aria-hidden="true"></i>
                  Last updated @Model.UpdatedAt.ToString("MMMM dd, yyyy 'at' h:mm tt")
                </span>
              </div>
            }
          </div>
        </div>

      </article>
    </div>

  </div>
</div>

@section Scripts {
  <script src="~/js/memorial-details.js" asp-append-version="true"></script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/memorial-details.css" asp-append-version="true" />
}
